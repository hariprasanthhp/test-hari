{"ast":null,"code":"import { HttpHeaders } from '@angular/common/http';\nimport { FormControl } from '@angular/forms';\nimport { DataTableDirective } from 'angular-datatables';\nimport { fromEvent, of, Subject } from 'rxjs';\nimport { catchError, debounceTime, distinctUntilChanged, switchMap } from 'rxjs/operators';\nimport { environment } from 'src/environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app-services/translate.service\";\nimport * as i2 from \"@angular/forms\";\nimport * as i3 from \"../shared/services/sso-auth.service\";\nimport * as i4 from \"@angular/common/http\";\nimport * as i5 from \"@angular/router\";\nimport * as i6 from \"../sys-admin/services/common.service\";\nimport * as i7 from \"@angular/platform-browser\";\nimport * as i8 from \"@angular/common\";\nimport * as i9 from \"angular-datatables\";\nfunction FederatedDashboardComponent_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 11);\n    i0.ɵɵelementStart(1, \"div\", 12);\n    i0.ɵɵelementStart(2, \"div\", 13);\n    i0.ɵɵelementStart(3, \"span\", 14);\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(ctx_r0.language.Loading);\n  }\n}\nfunction FederatedDashboardComponent_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 15);\n    i0.ɵɵelementStart(1, \"span\", 16);\n    i0.ɵɵelement(2, \"img\", 17);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"button\", 18);\n    i0.ɵɵlistener(\"click\", function FederatedDashboardComponent_div_2_Template_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r6);\n      const ctx_r5 = i0.ɵɵnextContext();\n      return ctx_r5.closeAlert();\n    });\n    i0.ɵɵelement(4, \"span\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(5, \"div\", 19);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"innerHtml\", ctx_r1.errorInfo, i0.ɵɵsanitizeHtml);\n  }\n}\nfunction FederatedDashboardComponent_div_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 20);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r2.language[\"Access denied due to RBAC. Please consult your Organization Administrator for access.\"], \" \");\n  }\n}\nfunction FederatedDashboardComponent_i_12_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r8 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"i\", 21);\n    i0.ɵɵlistener(\"click\", function FederatedDashboardComponent_i_12_Template_i_click_0_listener() {\n      i0.ɵɵrestoreView(_r8);\n      const ctx_r7 = i0.ɵɵnextContext();\n      return ctx_r7.clearSearchInp();\n    });\n    i0.ɵɵelementEnd();\n  }\n}\nfunction FederatedDashboardComponent_div_13_tr_7_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r13 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"tr\");\n    i0.ɵɵelementStart(1, \"td\", 26);\n    i0.ɵɵlistener(\"click\", function FederatedDashboardComponent_div_13_tr_7_Template_td_click_1_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r13);\n      const org_r11 = restoredCtx.$implicit;\n      const ctx_r12 = i0.ɵɵnextContext(2);\n      return ctx_r12.gotoFederatedAcccess(org_r11.grantor_org_id);\n    });\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const org_r11 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\" \", org_r11.grantor_org_name, \" \");\n  }\n}\nfunction FederatedDashboardComponent_div_13_tbody_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"tbody\");\n    i0.ɵɵelementStart(1, \"tr\");\n    i0.ɵɵelementStart(2, \"td\", 27);\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r10 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(ctx_r10.language[\"No matching records found\"]);\n  }\n}\nfunction FederatedDashboardComponent_div_13_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 22);\n    i0.ɵɵelementStart(1, \"table\", 23);\n    i0.ɵɵelementStart(2, \"thead\");\n    i0.ɵɵelementStart(3, \"tr\");\n    i0.ɵɵelementStart(4, \"th\");\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"tbody\");\n    i0.ɵɵtemplate(7, FederatedDashboardComponent_div_13_tr_7_Template, 3, 1, \"tr\", 24);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(8, FederatedDashboardComponent_div_13_tbody_8_Template, 4, 1, \"tbody\", 25);\n    i0.ɵɵelement(9, \"tbody\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r4 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"dtOptions\", ctx_r4.dtOptions);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(ctx_r4.language.Name);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r4.orgsList);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", (ctx_r4.orgsList == null ? null : ctx_r4.orgsList.length) == 0 || ctx_r4.count === 0 || ctx_r4.filterCount === 0);\n  }\n}\nexport let FederatedDashboardComponent = /*#__PURE__*/(() => {\n  class FederatedDashboardComponent {\n    constructor(translateService, fb, sso, http, router, commonOrgService, titleService) {\n      this.translateService = translateService;\n      this.fb = fb;\n      this.sso = sso;\n      this.http = http;\n      this.router = router;\n      this.commonOrgService = commonOrgService;\n      this.titleService = titleService;\n      this.searchOrg = new FormControl('');\n      this.isSecureAccess = false;\n      this.dtOptions = {};\n      this.dtTrigger = new Subject();\n      this.loading = false;\n      this.showTable = false;\n      this.hasScopeAccess = true;\n      this.orgsList = [];\n      this.accountsForm = this.fb.group({\n        org: ['']\n      });\n      this.errorInfo = '';\n      this.successInfo = '';\n      this.count = 0;\n    }\n    ngOnInit() {\n      this.isSecureAccess = this.sso.isSecureAccess();\n      this.language = this.translateService.defualtLanguage;\n      this.languageSubject = this.translateService.selectedLanguage.subscribe(data => {\n        this.language = data;\n        this.titleService.setTitle(`${this.language['Federated']} - ${this.language['Dashboards']} - ${this.language['Calix Cloud']}`);\n      });\n      this.titleService.setTitle(`${this.language['Federated']} - ${this.language['Dashboards']} - ${this.language['Calix Cloud']}`);\n      let landingPage = this.sso.getLandingPage();\n      if (!((landingPage === null || landingPage === void 0 ? void 0 : landingPage.toLowerCase()) === 'grantor_orgs')) {\n        this.router.navigate(['/login']);\n        return;\n      }\n      this.listenSearch();\n      this.subscribeCount('');\n    }\n    listenSearch() {\n      this.searchSub = fromEvent(document.getElementById('search-org'), 'keyup').pipe(debounceTime(200), distinctUntilChanged(), switchMap(e => {\n        this.orgsList = [];\n        return this.getCount(e.target.value);\n      })).subscribe(value => {\n        if (value === null || value === void 0 ? void 0 : value['api-error']) {\n          return;\n        }\n        //console.log(value);\n        this.filterCount = value;\n        //this.getData(this.searchOrg.value);\n        this.redraw();\n      });\n    }\n    getCount(searchValue) {\n      this.loading = true;\n      let url = `${environment.API_BASE_URL}grantor/orgs/_count`;\n      if (searchValue) {\n        url += `?filter=${searchValue}`;\n      }\n      return this.http.get(url).pipe(catchError(err => {\n        err['api-error'] = true;\n        this.showErrorMessage(this.commonOrgService.pageErrorHandle(err));\n        return of(err);\n      }));\n    }\n    subscribeCount(searchValue) {\n      this.getCount(searchValue).subscribe(value => {\n        if (value === null || value === void 0 ? void 0 : value['api-error']) {\n          return;\n        }\n        this.count = value;\n        this.filterCount = value;\n        if (this.initLoad) {\n          this.redraw();\n        } else {\n          this.getData(searchValue);\n        }\n      });\n    }\n    getData(searchValue) {\n      this.showTable = true;\n      this.dtOptions = {\n        pagingType: \"full_numbers\",\n        pageLength: 10,\n        serverSide: true,\n        processing: false,\n        lengthChange: false,\n        ordering: false,\n        dom: 'tipr',\n        ajax: (dataTablesParameters, callback) => {\n          let url = `${environment.API_BASE_URL}/grantor/orgs?offset=${dataTablesParameters.start}&size=${dataTablesParameters.length}&filter=${dataTablesParameters.search.value}`;\n          // if (searchValue) {\n          //   url += `&filter=${searchValue}`\n          // }\n          this.http.get(url).subscribe(resp => {\n            //console.log(resp);\n            this.orgsList = resp ? resp : [];\n            this.loading = false;\n            callback({\n              recordsTotal: this.count ? this.count : 0,\n              recordsFiltered: this.filterCount != undefined ? this.filterCount : this.count,\n              data: []\n            });\n          }, err => {\n            this.loading = false;\n            this.showErrorMessage(this.commonOrgService.pageErrorHandle(err));\n            callback({\n              recordsTotal: this.count ? this.count : 0,\n              recordsFiltered: this.filterCount != undefined ? this.filterCount : this.count,\n              data: []\n            });\n          }, () => {\n            this.initLoad = true;\n            this.loading = false;\n          });\n        },\n        drawCallback: settings => {\n          //this.changeTableStatusLanguage(settings);\n          // let total = settings._iRecordsDisplay; // for server side rendering\n          // let length = settings._iDisplayLength;\n          // if (total <= length) {\n          // }\n        }\n      };\n      this.tableLanguageOptions();\n    }\n    // ngAfterViewInit(): void {\n    //   this.dtTrigger.next();\n    // }\n    ngOnDestroy() {\n      // Do not forget to unsubscribe the event\n      //this.dtTrigger?.unsubscribe();\n      //this.searchSub?.unsubscribe();\n    }\n    // rerender(): void {\n    //   this.dtElement.dtInstance.then((dtInstance: DataTables.Api) => {\n    //     dtInstance.destroy();\n    //     this.dtTrigger.next();\n    //   });\n    // }\n    tableLanguageOptions() {\n      if (this.language.fileLanguage == 'de_DE') {\n        this.dtOptions.language = this.translateService.de_DE;\n      } else if (this.language.fileLanguage == 'fr') {\n        this.dtOptions.language = this.translateService.fr;\n      } else if (this.language.fileLanguage == 'es') {\n        this.dtOptions.language = this.translateService.es;\n      } else if (this.language.fileLanguage == 'en' && this.dtOptions.language) {\n        delete this.dtOptions.language;\n      }\n    }\n    gotoFederatedAcccess(orgId) {\n      this.loading = true;\n      // let data = {\n      //   client_secret: environment.X_CALIX_SECURE_CLIENTID,\n      //   orgid: orgId,\n      //   access_token: this.sso.getAccessToken()\n      // }\n      let headers = new HttpHeaders();\n      headers = headers.append('X-Calix-ClientID', environment.X_CALIX_CLIENTID);\n      headers = headers.append('Content-Type', 'application/x-www-form-urlencoded');\n      let data = `client_secret=${environment.X_CALIX_SECURE_CLIENTID}&orgid=${orgId}&access_token=${this.sso.getAccessToken()}`;\n      this.doSub = this.http.post(`${environment.API_BASE_URL}grantor/changeorg`, data, {\n        headers\n      }).subscribe(res => {\n        var _a;\n        //console.log(res);\n        this.loading = false;\n        if (res['access_token']) {\n          if (!((_a = res === null || res === void 0 ? void 0 : res.entitlements) === null || _a === void 0 ? void 0 : _a.length)) {\n            let msg = this.language['Error: No Valid Entitlement'];\n            this.showErrorMessage(msg);\n            return;\n          }\n          let apps = this.sso.showApps(res);\n          let keys = Object.keys(apps);\n          let hasValidApp = false;\n          keys === null || keys === void 0 ? void 0 : keys.forEach(type => {\n            if (apps[type]) {\n              hasValidApp = true;\n              return;\n            }\n          });\n          if (!hasValidApp) {\n            let msg = this.language['Error: No Valid Entitlement'];\n            this.showErrorMessage(msg);\n            return;\n          }\n          this.sso.setCSCLoggedIn(false);\n          //this.sso.setGracePeriodsByData(res.entitlements);\n          this.sso.setLoginInfo(res);\n          this.sso.setFederatedLogin(true);\n          if (res['landingPage'] && res['landingPage'].toLowerCase() == 'cco' && apps.cco) {\n            this.router.navigate(['/cco']);\n          } else if (res['landingPage'] && res['landingPage'].toLowerCase() == 'cmc' && apps.cmc) {\n            this.router.navigate(['/engagement']);\n          } else if (res['landingPage'] && (res['landingPage'].toLowerCase() == 'csc' || res['landingPage'].toLowerCase() == 'main page') && apps.csc) {\n            this.router.navigate(['/support']);\n          } else if (res['landingPage'] && res['landingPage'].toLowerCase() == 'DC' && apps.foundation) {\n            this.router.navigate(['/cco-foundation']);\n          } else {\n            this.gotoDP();\n          }\n        }\n      }, err => {\n        this.loading = false;\n      });\n    }\n    gotoDP() {\n      this.router.navigate([this.sso.getDefaultRoute()]);\n    }\n    closeAlert() {\n      this.error = false;\n      this.success = false;\n    }\n    showErrorMessage(msg) {\n      this.closeAlert();\n      this.errorInfo = msg;\n      this.error = true;\n      this.loading = false;\n      //this.commonOrgService.pageScrollTop();\n    }\n\n    clearSearchInp() {\n      this.searchOrg.setValue('');\n      this.subscribeCount('');\n    }\n    redraw() {\n      var _a, _b;\n      (_b = (_a = this.dtElement) === null || _a === void 0 ? void 0 : _a.dtInstance) === null || _b === void 0 ? void 0 : _b.then(dtInstance => {\n        dtInstance.search(this.searchOrg.value).draw();\n      });\n    }\n  }\n  FederatedDashboardComponent.ɵfac = function FederatedDashboardComponent_Factory(t) {\n    return new (t || FederatedDashboardComponent)(i0.ɵɵdirectiveInject(i1.TranslateService), i0.ɵɵdirectiveInject(i2.FormBuilder), i0.ɵɵdirectiveInject(i3.SsoAuthService), i0.ɵɵdirectiveInject(i4.HttpClient), i0.ɵɵdirectiveInject(i5.Router), i0.ɵɵdirectiveInject(i6.CommonService), i0.ɵɵdirectiveInject(i7.Title));\n  };\n  FederatedDashboardComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: FederatedDashboardComponent,\n    selectors: [[\"app-federated-dashboard\"]],\n    viewQuery: function FederatedDashboardComponent_Query(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵviewQuery(DataTableDirective, 5);\n      }\n      if (rf & 2) {\n        let _t;\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.dtElement = _t.first);\n      }\n    },\n    decls: 14,\n    vars: 8,\n    consts: [[1, \"row\"], [\"class\", \"loader\", 4, \"ngIf\"], [\"class\", \"w-100 alert alert-danger  fade show\", 4, \"ngIf\"], [1, \"col-md-12\"], [1, \"sub-imp-title\", \"d-flex\", \"justify-content-between\"], [1, \"\"], [\"role\", \"alert\", \"class\", \"alert alert-warning\", 4, \"ngIf\"], [1, \"col-md-3\", \"smy-2\", \"ccl-form\", \"mt-4\", \"position-relative\", \"px-0\"], [\"id\", \"search-org\", 1, \"ccl-input\", 3, \"placeholder\", \"formControl\"], [\"class\", \"search-close fas fa-times\", 3, \"click\", 4, \"ngIf\"], [\"class\", \"sub-imp-table\", 4, \"ngIf\"], [1, \"loader\"], [1, \"d-flex\", \"justify-content-center\"], [1, \"spinner-border\", \"text-primary\"], [1, \"sr-only\"], [1, \"w-100\", \"alert\", \"alert-danger\", \"fade\", \"show\"], [1, \"error-img\"], [\"src\", \"./assets/img/ic_error-36px.svg\"], [\"type\", \"button\", 1, \"close\", 3, \"click\"], [1, \"d-inline-flex\", 3, \"innerHtml\"], [\"role\", \"alert\", 1, \"alert\", \"alert-warning\"], [1, \"search-close\", \"fas\", \"fa-times\", 3, \"click\"], [1, \"sub-imp-table\"], [\"datatable\", \"\", 1, \"table\", \"table-borderless\", \"w-100\", 3, \"dtOptions\"], [4, \"ngFor\", \"ngForOf\"], [4, \"ngIf\"], [1, \"pointer\", \"blue\", 3, \"click\"], [\"colspan\", \"5\", 1, \"no-data-available\"]],\n    template: function FederatedDashboardComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"div\", 0);\n        i0.ɵɵtemplate(1, FederatedDashboardComponent_div_1_Template, 5, 1, \"div\", 1);\n        i0.ɵɵtemplate(2, FederatedDashboardComponent_div_2_Template, 6, 1, \"div\", 2);\n        i0.ɵɵelementStart(3, \"div\", 3);\n        i0.ɵɵelementStart(4, \"div\", 4);\n        i0.ɵɵelementStart(5, \"div\", 5);\n        i0.ɵɵtext(6);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(7, FederatedDashboardComponent_div_7_Template, 2, 1, \"div\", 6);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(8, \"div\", 0);\n        i0.ɵɵelementStart(9, \"div\", 3);\n        i0.ɵɵelementStart(10, \"div\", 7);\n        i0.ɵɵelement(11, \"input\", 8);\n        i0.ɵɵtemplate(12, FederatedDashboardComponent_i_12_Template, 1, 0, \"i\", 9);\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(13, FederatedDashboardComponent_div_13_Template, 10, 4, \"div\", 10);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementEnd();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.loading);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.error);\n        i0.ɵɵadvance(4);\n        i0.ɵɵtextInterpolate(ctx.language[\"selectAnOrganization\"]);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", !ctx.hasScopeAccess);\n        i0.ɵɵadvance(4);\n        i0.ɵɵpropertyInterpolate(\"placeholder\", ctx.language[\"Search Orgs\"]);\n        i0.ɵɵproperty(\"formControl\", ctx.searchOrg);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.searchOrg == null ? null : ctx.searchOrg.value);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.showTable);\n      }\n    },\n    directives: [i8.NgIf, i2.DefaultValueAccessor, i2.NgControlStatus, i2.FormControlDirective, i9.DataTableDirective, i8.NgForOf],\n    styles: [\".blue[_ngcontent-%COMP%]{color:#00f!important}.search-close[_ngcontent-%COMP%]{position:absolute;right:15px;top:10px;color:#cdcdcd;cursor:pointer}  table.dataTable td.dataTables_empty{display:none}\"]\n  });\n  return FederatedDashboardComponent;\n})();","map":null,"metadata":{},"sourceType":"module"}