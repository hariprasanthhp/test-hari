{"ast":null,"code":"import { assign } from 'min-dash';\nimport { getLabel } from './LabelUtil';\nimport { getBusinessObject, is } from '../../util/ModelUtil';\nimport { createCategoryValue } from '../modeling/behavior/util/CategoryUtil';\nimport { isAny } from '../modeling/util/ModelingUtil';\nimport { isExpanded } from '../../util/DiUtil';\nimport { getExternalLabelMid, isLabelExternal, hasExternalLabel, isLabel } from '../../util/LabelUtil';\nexport default function LabelEditingProvider(eventBus, bpmnFactory, canvas, directEditing, modeling, resizeHandles, textRenderer) {\n  this._bpmnFactory = bpmnFactory;\n  this._canvas = canvas;\n  this._modeling = modeling;\n  this._textRenderer = textRenderer;\n  directEditing.registerProvider(this);\n\n  // listen to dblclick on non-root elements\n  eventBus.on('element.dblclick', function (event) {\n    activateDirectEdit(event.element, true);\n  });\n\n  // complete on followup canvas operation\n  eventBus.on(['autoPlace.start', 'canvas.viewbox.changing', 'drag.init', 'element.mousedown', 'popupMenu.open'], function (event) {\n    if (directEditing.isActive()) {\n      directEditing.complete();\n    }\n  });\n\n  // cancel on command stack changes\n  eventBus.on(['commandStack.changed'], function (e) {\n    if (directEditing.isActive()) {\n      directEditing.cancel();\n    }\n  });\n  eventBus.on('directEditing.activate', function (event) {\n    resizeHandles.removeResizers();\n  });\n  eventBus.on('create.end', 500, function (event) {\n    var context = event.context,\n      element = context.shape,\n      canExecute = event.context.canExecute,\n      isTouch = event.isTouch;\n\n    // TODO(nikku): we need to find a way to support the\n    // direct editing on mobile devices; right now this will\n    // break for desworkflowediting on mobile devices\n    // as it breaks the user interaction workflow\n\n    // TODO(nre): we should temporarily focus the edited element\n    // here and release the focused viewport after the direct edit\n    // operation is finished\n    if (isTouch) {\n      return;\n    }\n    if (!canExecute) {\n      return;\n    }\n    if (context.hints && context.hints.createElementsBehavior === false) {\n      return;\n    }\n    activateDirectEdit(element);\n  });\n  eventBus.on('autoPlace.end', 500, function (event) {\n    activateDirectEdit(event.shape);\n  });\n  function activateDirectEdit(element, force) {\n    if (force || isAny(element, ['bpmn:Task', 'bpmn:TextAnnotation', 'bpmn:Group']) || isCollapsedSubProcess(element)) {\n      directEditing.activate(element);\n    }\n  }\n}\nLabelEditingProvider.$inject = ['eventBus', 'bpmnFactory', 'canvas', 'directEditing', 'modeling', 'resizeHandles', 'textRenderer'];\n\n/**\n * Activate direct editing for activities and text annotations.\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object with properties bounds (position and size), text and options\n */\nLabelEditingProvider.prototype.activate = function (element) {\n  // text\n  var text = getLabel(element);\n  if (text === undefined) {\n    return;\n  }\n  var context = {\n    text: text\n  };\n\n  // bounds\n  var bounds = this.getEditingBBox(element);\n  assign(context, bounds);\n  var options = {};\n\n  // tasks\n  if (isAny(element, ['bpmn:Task', 'bpmn:Participant', 'bpmn:Lane', 'bpmn:CallActivity']) || isCollapsedSubProcess(element)) {\n    assign(options, {\n      centerVertically: true\n    });\n  }\n\n  // external labels\n  if (isLabelExternal(element)) {\n    assign(options, {\n      autoResize: true\n    });\n  }\n\n  // text annotations\n  if (is(element, 'bpmn:TextAnnotation')) {\n    assign(options, {\n      resizable: true,\n      autoResize: true\n    });\n  }\n  assign(context, {\n    options: options\n  });\n  return context;\n};\n\n/**\n * Get the editing bounding box based on the element's size and position\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object containing information about position\n *                  and size (fixed or minimum and/or maximum)\n */\nLabelEditingProvider.prototype.getEditingBBox = function (element) {\n  var canvas = this._canvas;\n  var target = element.label || element;\n  var bbox = canvas.getAbsoluteBBox(target);\n  var mid = {\n    x: bbox.x + bbox.width / 2,\n    y: bbox.y + bbox.height / 2\n  };\n\n  // default position\n  var bounds = {\n    x: bbox.x,\n    y: bbox.y\n  };\n  var zoom = canvas.zoom();\n  var defaultStyle = this._textRenderer.getDefaultStyle(),\n    externalStyle = this._textRenderer.getExternalStyle();\n\n  // take zoom into account\n  var externalFontSize = externalStyle.fontSize * zoom,\n    externalLineHeight = externalStyle.lineHeight,\n    defaultFontSize = defaultStyle.fontSize * zoom,\n    defaultLineHeight = defaultStyle.lineHeight;\n  var style = {\n    fontFamily: this._textRenderer.getDefaultStyle().fontFamily,\n    fontWeight: this._textRenderer.getDefaultStyle().fontWeight\n  };\n\n  // adjust for expanded pools AND lanes\n  if (is(element, 'bpmn:Lane') || isExpandedPool(element)) {\n    assign(bounds, {\n      width: bbox.height,\n      height: 30 * zoom,\n      x: bbox.x - bbox.height / 2 + 15 * zoom,\n      y: mid.y - 30 * zoom / 2\n    });\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: 7 * zoom + 'px',\n      paddingBottom: 7 * zoom + 'px',\n      paddingLeft: 5 * zoom + 'px',\n      paddingRight: 5 * zoom + 'px',\n      transform: 'rotate(-90deg)'\n    });\n  }\n\n  // internal labels for tasks and collapsed call activities,\n  // sub processes and participants\n  if (isAny(element, ['bpmn:Task', 'bpmn:CallActivity']) || isCollapsedPool(element) || isCollapsedSubProcess(element)) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height\n    });\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: 7 * zoom + 'px',\n      paddingBottom: 7 * zoom + 'px',\n      paddingLeft: 5 * zoom + 'px',\n      paddingRight: 5 * zoom + 'px'\n    });\n  }\n\n  // internal labels for expanded sub processes\n  if (isExpandedSubProcess(element)) {\n    assign(bounds, {\n      width: bbox.width,\n      x: bbox.x\n    });\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: 7 * zoom + 'px',\n      paddingBottom: 7 * zoom + 'px',\n      paddingLeft: 5 * zoom + 'px',\n      paddingRight: 5 * zoom + 'px'\n    });\n  }\n  var width = 90 * zoom,\n    paddingTop = 7 * zoom,\n    paddingBottom = 4 * zoom;\n\n  // external labels for events, data elements, gateways, groups and connections\n  if (target.labelTarget) {\n    assign(bounds, {\n      width: width,\n      height: bbox.height + paddingTop + paddingBottom,\n      x: mid.x - width / 2,\n      y: bbox.y - paddingTop\n    });\n    assign(style, {\n      fontSize: externalFontSize + 'px',\n      lineHeight: externalLineHeight,\n      paddingTop: paddingTop + 'px',\n      paddingBottom: paddingBottom + 'px'\n    });\n  }\n\n  // external label not yet created\n  if (isLabelExternal(target) && !hasExternalLabel(target) && !isLabel(target)) {\n    var externalLabelMid = getExternalLabelMid(element);\n    var absoluteBBox = canvas.getAbsoluteBBox({\n      x: externalLabelMid.x,\n      y: externalLabelMid.y,\n      width: 0,\n      height: 0\n    });\n    var height = externalFontSize + paddingTop + paddingBottom;\n    assign(bounds, {\n      width: width,\n      height: height,\n      x: absoluteBBox.x - width / 2,\n      y: absoluteBBox.y - height / 2\n    });\n    assign(style, {\n      fontSize: externalFontSize + 'px',\n      lineHeight: externalLineHeight,\n      paddingTop: paddingTop + 'px',\n      paddingBottom: paddingBottom + 'px'\n    });\n  }\n\n  // text annotations\n  if (is(element, 'bpmn:TextAnnotation')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height,\n      minWidth: 30 * zoom,\n      minHeight: 10 * zoom\n    });\n    assign(style, {\n      textAlign: 'left',\n      paddingTop: 5 * zoom + 'px',\n      paddingBottom: 7 * zoom + 'px',\n      paddingLeft: 7 * zoom + 'px',\n      paddingRight: 5 * zoom + 'px',\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight\n    });\n  }\n  return {\n    bounds: bounds,\n    style: style\n  };\n};\nLabelEditingProvider.prototype.update = function (element, newLabel, activeContextText, bounds) {\n  var newBounds, bbox;\n  if (is(element, 'bpmn:TextAnnotation')) {\n    bbox = this._canvas.getAbsoluteBBox(element);\n    newBounds = {\n      x: element.x,\n      y: element.y,\n      width: element.width / bbox.width * bounds.width,\n      height: element.height / bbox.height * bounds.height\n    };\n  }\n  if (is(element, 'bpmn:Group')) {\n    var businessObject = getBusinessObject(element);\n\n    // initialize categoryValue if not existing\n    if (!businessObject.categoryValueRef) {\n      var rootElement = this._canvas.getRootElement(),\n        definitions = getBusinessObject(rootElement).$parent;\n      var categoryValue = createCategoryValue(definitions, this._bpmnFactory);\n      getBusinessObject(element).categoryValueRef = categoryValue;\n    }\n  }\n  if (isEmptyText(newLabel)) {\n    newLabel = null;\n  }\n  this._modeling.updateLabel(element, newLabel, newBounds);\n};\n\n// helpers //////////////////////\n\nfunction isCollapsedSubProcess(element) {\n  return is(element, 'bpmn:SubProcess') && !isExpanded(element);\n}\nfunction isExpandedSubProcess(element) {\n  return is(element, 'bpmn:SubProcess') && isExpanded(element);\n}\nfunction isCollapsedPool(element) {\n  return is(element, 'bpmn:Participant') && !isExpanded(element);\n}\nfunction isExpandedPool(element) {\n  return is(element, 'bpmn:Participant') && isExpanded(element);\n}\nfunction isEmptyText(label) {\n  return !label || !label.trim();\n}","map":null,"metadata":{},"sourceType":"module"}